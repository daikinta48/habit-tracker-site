---
import BaseLayout from './BaseLayout.astro';
import Footer from '../components/Footer.astro';

interface RelatedPost {
  slug: string;
  data: {
    title: string;
    description: string;
    pubDate: Date;
    tags?: string[];
  };
}

interface Props {
  title: string;
  description: string;
  pubDate: Date;
  updatedDate?: Date;
  tags?: string[];
  readingTime?: number;
  relatedPosts?: RelatedPost[];
  slug: string;
}

const { title, description, pubDate, updatedDate, tags, readingTime, relatedPosts, slug } = Astro.props;

const siteUrl = Astro.site?.href.replace(/\/$/, '') ?? '';
const canonicalPath = `/blog/${slug}`;
const canonicalUrl = `${siteUrl}${canonicalPath}`;
const pubDateISO = pubDate.toISOString();
const updatedDateISO = updatedDate?.toISOString() ?? pubDateISO;

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: title,
  description: description,
  url: canonicalUrl,
  datePublished: pubDateISO,
  dateModified: updatedDateISO,
  author: {
    '@type': 'Organization',
    name: 'Habit Tracker',
    url: siteUrl,
  },
  publisher: {
    '@type': 'Organization',
    name: 'Habit Tracker',
    url: siteUrl,
  },
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': canonicalUrl,
  },
  ...(tags && tags.length > 0 ? { keywords: tags.join(', ') } : {}),
};

const breadcrumbJsonLd = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: 'ホーム', item: siteUrl },
    { '@type': 'ListItem', position: 2, name: 'ブログ', item: `${siteUrl}/blog` },
    { '@type': 'ListItem', position: 3, name: title, item: canonicalUrl },
  ],
};
---
<BaseLayout
  title={`${title} - Habit Tracker`}
  description={description}
  ogType="article"
  canonicalPath={canonicalPath}
>
  <Fragment slot="head">
    <meta property="article:published_time" content={pubDateISO} />
    <meta property="article:modified_time" content={updatedDateISO} />
    {tags && tags.map((tag) => (
      <meta property="article:tag" content={tag} />
    ))}
    <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
    <script type="application/ld+json" set:html={JSON.stringify(breadcrumbJsonLd)} />
  </Fragment>

  <article class="container blog-post">
    <header class="post-header">
      <nav class="breadcrumb" aria-label="パンくずリスト">
        <ol class="breadcrumb-list">
          <li><a href="/">ホーム</a></li>
          <li><a href="/blog">ブログ</a></li>
          <li aria-current="page">{title}</li>
        </ol>
      </nav>

      <div class="post-meta">
        <time datetime={pubDateISO}>
          {pubDate.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' })}
        </time>
        {updatedDate && (
          <span class="updated-date">
            更新: {updatedDate.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' })}
          </span>
        )}
        {readingTime && (
          <span class="reading-time">約{readingTime}分で読めます</span>
        )}
      </div>

      <h1>{title}</h1>

      {tags && tags.length > 0 && (
        <div class="post-tags">
          {tags.map((tag) => (
            <a href={`/blog/tag/${tag}`} class="tag">{tag}</a>
          ))}
        </div>
      )}
    </header>

    <div class="prose">
      <slot />
    </div>

    {relatedPosts && relatedPosts.length > 0 && (
      <aside class="related-posts">
        <h2 class="related-title">関連記事</h2>
        <ul class="related-list">
          {relatedPosts.map((p) => (
            <li class="related-card">
              <a href={`/blog/${p.slug}`} class="related-link">
                <span class="related-post-title">{p.data.title}</span>
                <span class="related-post-desc">{p.data.description}</span>
              </a>
              {p.data.tags && p.data.tags.length > 0 && (
                <div class="related-tags">
                  {p.data.tags.map((tag) => (
                    <a href={`/blog/tag/${tag}`} class="tag tag--sm">{tag}</a>
                  ))}
                </div>
              )}
            </li>
          ))}
        </ul>
      </aside>
    )}
  </article>
  <Footer />
</BaseLayout>

<style>
  .blog-post {
    padding-top: 48px;
    padding-bottom: 80px;
  }

  /* パンくずリスト */
  .breadcrumb {
    margin-bottom: 24px;
  }

  .breadcrumb-list {
    list-style: none;
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    font-size: 0.8125rem;
    color: var(--text-muted);
  }

  .breadcrumb-list li + li::before {
    content: '›';
    margin-right: 4px;
  }

  .breadcrumb-list a {
    color: var(--primary);
    text-decoration: none;
  }

  .breadcrumb-list a:hover {
    text-decoration: underline;
  }

  .post-header {
    margin-bottom: 40px;
  }

  .post-meta {
    display: flex;
    align-items: center;
    gap: 0;
    flex-wrap: wrap;
    margin-bottom: 16px;
  }

  .post-meta time {
    font-size: 0.875rem;
    color: var(--text-muted);
  }

  .updated-date {
    font-size: 0.875rem;
    color: var(--text-muted);
  }

  .updated-date::before {
    content: '·';
    margin: 0 8px;
    opacity: 0.4;
  }

  .reading-time {
    font-size: 0.875rem;
    color: var(--text-muted);
  }

  .reading-time::before {
    content: '·';
    margin: 0 8px;
    opacity: 0.4;
  }

  .post-header h1 {
    font-size: clamp(1.5rem, 4vw, 2rem);
    font-weight: 700;
    color: var(--text-dark);
    letter-spacing: -0.02em;
    line-height: 1.4;
    margin-bottom: 16px;
  }

  /* 記事タグ */
  .post-tags {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }

  .tag {
    font-size: 0.75rem;
    background: var(--primary-light);
    color: var(--primary);
    padding: 3px 10px;
    border-radius: 99px;
    font-weight: 500;
    text-decoration: none;
    transition: background 0.15s, color 0.15s;
  }

  .tag:hover {
    background: var(--primary);
    color: #fff;
  }

  .tag--sm {
    font-size: 0.6875rem;
    padding: 2px 8px;
  }

  /* Markdown コンテンツのスタイル */
  .prose :global(h2) {
    font-size: 1.375rem;
    font-weight: 700;
    color: var(--text-dark);
    margin: 40px 0 16px;
    letter-spacing: -0.01em;
  }

  .prose :global(h3) {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-dark);
    margin: 32px 0 12px;
  }

  .prose :global(p) {
    margin-bottom: 20px;
    color: var(--text-body);
    line-height: 1.9;
  }

  .prose :global(ul),
  .prose :global(ol) {
    padding-left: 24px;
    margin-bottom: 20px;
  }

  .prose :global(li) {
    margin-bottom: 8px;
    color: var(--text-body);
    line-height: 1.8;
  }

  .prose :global(a) {
    color: var(--primary);
    text-decoration: underline;
  }

  .prose :global(a:hover) {
    color: var(--primary-dark);
  }

  .prose :global(code) {
    background: var(--primary-light);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.875em;
    font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
  }

  .prose :global(pre) {
    background: var(--text-dark);
    color: #f8f8f2;
    padding: 20px;
    border-radius: var(--radius-md);
    overflow-x: auto;
    margin-bottom: 24px;
  }

  .prose :global(pre code) {
    background: none;
    padding: 0;
    font-size: 0.9375rem;
  }

  .prose :global(blockquote) {
    border-left: 4px solid var(--primary);
    padding-left: 20px;
    margin: 0 0 20px;
    color: var(--text-muted);
    font-style: italic;
  }

  .prose :global(hr) {
    border: none;
    border-top: 1px solid var(--border);
    margin: 40px 0;
  }

  .prose :global(img) {
    max-width: 100%;
    border-radius: var(--radius-md);
    margin: 8px 0;
  }

  /* 関連記事 */
  .related-posts {
    margin-top: 64px;
    padding-top: 40px;
    border-top: 1px solid var(--border);
  }

  .related-title {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--text-dark);
    margin-bottom: 20px;
  }

  .related-list {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .related-card {
    position: relative;
    background: var(--bg-white);
    border-radius: var(--radius-md);
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .related-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
  }

  .related-link {
    display: block;
    text-decoration: none;
  }

  .related-link::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: inherit;
    z-index: 1;
  }

  .related-post-title {
    display: block;
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 4px;
    line-height: 1.5;
  }

  .related-post-desc {
    display: block;
    font-size: 0.875rem;
    color: var(--text-muted);
    line-height: 1.6;
  }

  .related-tags {
    position: relative;
    z-index: 2;
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin-top: 10px;
  }
</style>
